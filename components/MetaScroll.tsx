import React, { useEffect, useState, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Shield, Box, Gauge, FileText, RefreshCcw, FileCode, Search, Settings, MessageSquare, Workflow, TrendingUp, CheckCircle2 } from 'lucide-react';
import GlowingCard from './GlowingCard';

// New 4-step lifecycle stages
interface LifecycleStage {
    id: number;
    name: string;
    title: string;
    description: string;
    position: { x: number; y: number };
}

const lifecycleStages: LifecycleStage[] = [
    {
        id: 1,
        name: "DISCOVERY",
        title: "Smart Analyzing",
        description: "Identify AI solutions to streamline workflows and improve efficiency.",
        position: { x: 15, y: 15 },
    },
    {
        id: 2,
        name: "DEVELOPMENT",
        title: "AI Development",
        description: "Build intelligent automation systems tailored to your business.",
        position: { x: 60, y: 15 },
    },
    {
        id: 3,
        name: "INTEGRATION",
        title: "Seamless Integration",
        description: "Integrate AI with minimal disruption to your infrastructure.",
        position: { x: 15, y: 65 },
    },
    {
        id: 4,
        name: "OPTIMIZATION",
        title: "Optimization",
        description: "Refine performance and enhance automation for growth.",
        position: { x: 60, y: 65 },
    }
];

// Scroll distance multiplier
const SCROLL_MULTIPLIER = 2;

// Step 1: Radar Scan Animation Component
const RadarScan = () => {
    return (
        <div className="relative w-full aspect-square max-w-[160px] mx-auto">
            {/* Outer circle */}
            <div className="absolute inset-0 rounded-full border-2 border-gray-700/50" />
            {/* Inner glow */}
            <div className="absolute inset-4 rounded-full border border-gray-700/30" />
            {/* Radar sweep */}
            <motion.div
                className="absolute inset-0 origin-center"
                animate={{ rotate: 360 }}
                transition={{ duration: 3, repeat: Infinity, ease: "linear" }}
            >
                <div
                    className="absolute top-1/2 left-1/2 w-1/2 h-1"
                    style={{
                        background: 'linear-gradient(90deg, transparent 0%, #a855f7 50%, #7c3aed 100%)',
                        transformOrigin: 'left center',
                        transform: 'translateY(-50%)',
                    }}
                />
                {/* Pie slice */}
                <div
                    className="absolute top-0 left-1/2 w-1/2 h-1/2 origin-bottom-left"
                    style={{
                        background: 'conic-gradient(from 0deg, rgba(168, 85, 247, 0.4) 0deg, transparent 45deg)',
                        borderRadius: '0 100% 0 0',
                    }}
                />
            </motion.div>
            {/* Center dot */}
            <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-purple-500 rounded-full transform -translate-x-1/2 -translate-y-1/2" />
            {/* Label */}
            <p className="absolute -bottom-6 left-0 right-0 text-center text-gray-400 text-xs">
                Analyzing current workflow...
            </p>
        </div>
    );
};

// Step 2: Code Editor Animation Component
const CodeEditor = () => {
    const codeLines = [
        { indent: 0, content: <><span className="text-purple-400">def</span> <span className="text-blue-400">get_status</span><span className="text-yellow-400">(self)</span>:</> },
        { indent: 1, content: <><span className="text-purple-400">return</span> <span className="text-green-400">f"Status: {'{'}self.status{'}'}"</span></> },
        { indent: 0, content: "" },
        { indent: 0, content: <><span className="text-purple-400">class</span> <span className="text-blue-400">AutomationTrigger</span>:</> },
        { indent: 1, content: <><span className="text-gray-400">def __init__(self, threshold):</span></> },
        { indent: 2, content: <span className="text-gray-400">self.threshold = threshold</span> },
        { indent: 2, content: <span className="text-gray-400">self.status = "inactive"</span> },
        { indent: 0, content: "" },
        { indent: 1, content: <><span className="text-purple-400">def</span> <span className="text-blue-400">activate</span><span className="text-yellow-400">(self)</span>:</> },
        { indent: 2, content: <span className="text-gray-400">self.status = "active"</span> },
    ];

    return (
        <div className="bg-black/60 border border-gray-800 rounded-xl overflow-hidden">
            {/* Editor header */}
            <div className="bg-black/80 px-3 py-2 flex items-center justify-between border-b border-gray-800">
                <div className="flex items-center gap-2 text-gray-500">
                    <span className="text-xs">←</span>
                    <span className="text-xs">→</span>
                </div>
                <div className="flex-1 mx-4">
                    <div className="h-1 bg-gray-800 rounded-full w-16 mx-auto" />
                </div>
                <div className="flex items-center gap-2 text-gray-500 text-xs">
                    <span>□</span>
                    <span>—</span>
                    <span>×</span>
                </div>
            </div>

            <div className="flex">
                {/* Sidebar */}
                <div className="bg-black/40 border-r border-gray-800 p-3 space-y-3">
                    <FileCode className="w-4 h-4 text-gray-500" />
                    <Search className="w-4 h-4 text-gray-500" />
                    <Settings className="w-4 h-4 text-gray-500" />
                </div>

                {/* Code area with infinite scroll animation */}
                <div
                    className="flex-1 p-4 font-mono text-xs overflow-hidden relative h-[140px]"
                    style={{
                        maskImage: 'linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%)',
                        WebkitMaskImage: 'linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%)',
                    }}
                >
                    <div className="animate-code-scroll">
                        {/* Triple repeat for seamless infinite loop */}
                        {[...codeLines, ...codeLines, ...codeLines].map((line, i) => (
                            <div key={i} className="whitespace-nowrap leading-5" style={{ paddingLeft: `${line.indent * 16}px` }}>
                                {line.content || '\u00A0'}
                            </div>
                        ))}
                    </div>
                    <style>{`
                        @keyframes codeScroll {
                            0% { transform: translateY(0); }
                            100% { transform: translateY(-33.333%); }
                        }
                        .animate-code-scroll {
                            animation: codeScroll 8s linear infinite;
                        }
                    `}</style>
                </div>
            </div>
        </div>
    );
};

// Step 3: Integration Animation Component
const IntegrationVisual = () => {
    return (
        <div className="bg-[#0a0a0a] border border-gray-800/50 rounded-2xl p-8 sm:p-10">
            <div className="flex items-center justify-center gap-8">
                {/* Our solution - animated circles */}
                <div className="text-center">
                    <motion.div
                        className="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br from-purple-600 to-purple-900 mx-auto mb-3 flex items-center justify-center"
                        animate={{ rotate: [0, 360] }}
                        transition={{ duration: 8, repeat: Infinity, ease: "linear" }}
                    >
                        <motion.div
                            className="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-purple-400/50"
                            animate={{ scale: [1, 1.2, 1] }}
                            transition={{ duration: 2, repeat: Infinity }}
                        />
                    </motion.div>
                    <span className="text-gray-400 text-xs">Our solution</span>
                </div>

                {/* Connection dots */}
                <div className="flex items-center gap-1">
                    {[0, 1, 2].map((i) => (
                        <motion.div
                            key={i}
                            className="w-2 h-2 bg-purple-500 rounded-full"
                            animate={{ opacity: [0.3, 1, 0.3], scale: [0.8, 1.2, 0.8] }}
                            transition={{ duration: 1.5, repeat: Infinity, delay: i * 0.3 }}
                        />
                    ))}
                </div>

                {/* Your stack */}
                <div className="text-center">
                    <motion.div
                        className="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-purple-600 to-violet-900 rounded-xl mx-auto mb-3 flex items-center justify-center"
                        animate={{ rotate: [0, 5, 0, -5, 0] }}
                        transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                    >
                        <span className="text-purple-300 text-2xl font-bold">M</span>
                    </motion.div>
                    <span className="text-gray-400 text-xs">Your stack</span>
                </div>
            </div>
        </div>
    );
};

// Step 4: Optimization Status Component
const OptimizationStatus = () => {
    const systems = [
        { icon: MessageSquare, name: "Chatbot system", status: "Efficiency will increase by 20%", statusIcon: "loading" },
        { icon: Workflow, name: "Workflow system", status: "Update available", statusIcon: "up" },
        { icon: TrendingUp, name: "Sales system", status: "Up to date", statusIcon: "check" },
    ];

    return (
        <div className="space-y-3">
            {systems.map((system, idx) => (
                <motion.div
                    key={system.name}
                    initial={{ opacity: 0, x: -20 }}
                    whileInView={{ opacity: 1, x: 0 }}
                    viewport={{ once: true }}
                    transition={{ delay: idx * 0.15 }}
                    className="bg-black/40 border border-gray-800 rounded-xl p-4 flex items-center gap-4"
                >
                    <div className="w-10 h-10 bg-black/60 border border-gray-700 rounded-lg flex items-center justify-center flex-shrink-0">
                        <system.icon className="w-5 h-5 text-gray-400" />
                    </div>
                    <div className="flex-1 min-w-0">
                        <span className="text-white text-sm font-medium block">{system.name}</span>
                        <span className="text-gray-500 text-xs">{system.status}</span>
                    </div>
                    <div className="flex-shrink-0">
                        {system.statusIcon === "loading" && (
                            <motion.div
                                animate={{ rotate: 360 }}
                                transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
                            >
                                <div className="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full" />
                            </motion.div>
                        )}
                        {system.statusIcon === "up" && <TrendingUp className="w-5 h-5 text-purple-500" />}
                        {system.statusIcon === "check" && <CheckCircle2 className="w-5 h-5 text-purple-500" />}
                    </div>
                </motion.div>
            ))}
        </div>
    );
};

// Step check items for Step 1
const step1Items = [
    { icon: Shield, label: "System check" },
    { icon: Box, label: "Process check" },
    { icon: Gauge, label: "Speed check" },
    { icon: FileText, label: "Manual work" },
    { icon: RefreshCcw, label: "Repetitive task" },
];

export const CustomerLifecycleSection = () => {
    const [visibleStages, setVisibleStages] = useState<number[]>([]);
    const containerRef = useRef<HTMLDivElement>(null);
    const [scrollProgress, setScrollProgress] = useState(0);
    const [smoothProgress, setSmoothProgress] = useState(0);
    const [isFixed, setIsFixed] = useState(false);
    const [isAtBottom, setIsAtBottom] = useState(false);

    // Continuously update smooth progress
    useEffect(() => {
        let animationId: number;
        const animate = () => {
            setSmoothProgress(prev => {
                const diff = scrollProgress - prev;
                if (Math.abs(diff) < 0.001) return scrollProgress;
                return prev + diff * 0.12;
            });
            animationId = requestAnimationFrame(animate);
        };
        animationId = requestAnimationFrame(animate);
        return () => cancelAnimationFrame(animationId);
    }, [scrollProgress]);

    // Update visible stages based on smooth progress
    useEffect(() => {
        const stagesToShow = Math.floor(smoothProgress * lifecycleStages.length * 1.5);
        const newVisibleStages = lifecycleStages
            .slice(0, Math.min(lifecycleStages.length, stagesToShow + 1))
            .map(stage => stage.id);
        setVisibleStages(newVisibleStages);
    }, [smoothProgress]);

    // Scroll-based progress calculation
    useEffect(() => {
        const handleScroll = () => {
            if (!containerRef.current) return;

            const rect = containerRef.current.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            const scrollDistance = windowHeight * SCROLL_MULTIPLIER;

            if (rect.top > 0) {
                setIsFixed(false);
                setIsAtBottom(false);
                setScrollProgress(0);
                return;
            }

            if (rect.bottom <= windowHeight) {
                setIsFixed(false);
                setIsAtBottom(true);
                setScrollProgress(1);
                return;
            }

            const scrolledIntoSection = -rect.top;
            const progress = Math.max(0, Math.min(1, scrolledIntoSection / scrollDistance));

            setIsFixed(true);
            setIsAtBottom(false);
            setScrollProgress(progress);
        };

        window.addEventListener("scroll", handleScroll, { passive: true });
        handleScroll();

        return () => window.removeEventListener("scroll", handleScroll);
    }, []);

    const getContentStyle = (): React.CSSProperties => {
        if (isFixed) {
            return {
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                height: '100vh',
                zIndex: 10,
            };
        }

        if (isAtBottom) {
            return {
                position: 'absolute',
                bottom: 0,
                left: 0,
                right: 0,
                height: '100vh',
            };
        }

        return {
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            height: '100vh',
        };
    };

    // Render step card for mobile
    const renderStepCard = (step: number) => {
        switch (step) {
            case 1:
                return (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                        <div className="flex items-center justify-center py-4">
                            <RadarScan />
                        </div>
                        <div className="space-y-2">
                            {step1Items.map((item, i) => (
                                <motion.div
                                    key={item.label}
                                    initial={{ opacity: 0, x: 10 }}
                                    whileInView={{ opacity: 1, x: 0 }}
                                    viewport={{ once: true }}
                                    transition={{ delay: i * 0.1 }}
                                    className="bg-black/40 border border-gray-800 rounded-lg px-3 py-2 flex items-center gap-2"
                                >
                                    <item.icon className="w-3 h-3 sm:w-4 sm:h-4 text-gray-400 flex-shrink-0" />
                                    <span className="text-white text-xs sm:text-sm">{item.label}</span>
                                </motion.div>
                            ))}
                        </div>
                    </div>
                );
            case 2:
                return <div className="mt-6"><CodeEditor /></div>;
            case 3:
                return <div className="mt-6"><IntegrationVisual /></div>;
            case 4:
                return <div className="mt-6"><OptimizationStatus /></div>;
            default:
                return null;
        }
    };

    return (
        <>
            {/* Mobile: Process Steps Cards */}
            <section id="lifecycle" className="md:hidden bg-[#050505] py-12 sm:py-16 px-4">
                <div className="max-w-lg mx-auto">
                    {/* Section Header */}
                    <div className="text-center mb-8 sm:mb-10">
                        <h2 className="text-xl sm:text-2xl font-bold text-white mb-2 sm:mb-3 px-2">
                            Drive value across the{" "}
                            <span className="text-purple-400">customer lifecycle</span>
                        </h2>
                        <p className="text-gray-400 text-xs sm:text-sm px-2">
                            Each touchpoint is a revenue opportunity
                        </p>
                    </div>

                    {/* Process Steps */}
                    <div className="space-y-4 sm:space-y-6">
                        {lifecycleStages.map((stage, idx) => (
                            <motion.div
                                key={stage.id}
                                initial={{ opacity: 0, y: 24 }}
                                whileInView={{ opacity: 1, y: 0 }}
                                viewport={{ once: true, margin: "-10% 0px" }}
                                transition={{ duration: 0.5, delay: 0.1 * idx }}
                                className="rounded-3xl"
                            >
                                <GlowingCard className="rounded-3xl h-full">
                                    <div className="p-4 sm:p-6 md:p-8">
                                        {/* Step badge with gradient */}
                                        <span className="inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-gradient-to-r from-purple-600 to-violet-600 rounded-lg text-white text-xs sm:text-sm font-bold mb-4 sm:mb-6 shadow-lg shadow-purple-500/20 uppercase tracking-wider">
                                            Step {stage.id}
                                        </span>

                                        {/* Title */}
                                        <h3 className="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-2 sm:mb-3 leading-tight">
                                            {stage.title}
                                        </h3>

                                        {/* Description */}
                                        <p className="text-gray-400 text-sm sm:text-base leading-relaxed mb-3 sm:mb-4">
                                            {stage.description}
                                        </p>

                                        {/* Visual content */}
                                        {renderStepCard(stage.id)}
                                    </div>
                                </GlowingCard>
                            </motion.div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Desktop/Tablet: Fixed scroll-driven animation */}
            <section
                id="lifecycle-desktop"
                ref={containerRef}
                className="hidden md:block relative bg-[#050505]"
                style={{
                    height: `${100 + (100 * SCROLL_MULTIPLIER)}vh`
                }}
            >
                <div
                    className="bg-[#050505]"
                    style={getContentStyle()}
                >
                    <div className="h-full flex items-center justify-center pb-20">
                        <div className="container mx-auto px-6 lg:px-12 flex flex-col gap-12 items-center">
                            {/* Infinity Loop Diagram */}
                            <div className="relative h-[300px] sm:h-[420px] md:h-[520px] lg:h-[600px] w-full max-w-5xl">
                                {/* Infinity Loop Path */}
                                <svg
                                    className="absolute inset-0 w-full h-full"
                                    viewBox="0 0 400 300"
                                    style={{
                                        opacity: smoothProgress > 0 ? 1 : 0,
                                        transition: 'opacity 0.8s ease-out'
                                    }}
                                >
                                    <defs>
                                        <linearGradient id="pathGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stopColor="#7c3aed" stopOpacity="0.3" />
                                            <stop offset="50%" stopColor="#a855f7" stopOpacity="0.6" />
                                            <stop offset="100%" stopColor="#7c3aed" stopOpacity="0.3" />
                                        </linearGradient>
                                    </defs>
                                    <path
                                        d="M 80 150 C 80 80 160 80 200 150 C 240 220 320 220 320 150 C 320 80 240 80 200 150 C 160 220 80 220 80 150"
                                        fill="none"
                                        stroke="url(#pathGradient)"
                                        strokeWidth="3"
                                        strokeLinecap="round"
                                        style={{
                                            strokeDasharray: 1000,
                                            strokeDashoffset: 1000 - (1000 * smoothProgress),
                                            transition: 'none'
                                        }}
                                    />
                                </svg>

                                {/* Lifecycle Stages - 4 steps */}
                                <AnimatePresence>
                                    {lifecycleStages.map((stage) => (
                                        <motion.div
                                            key={stage.id}
                                            initial={{ opacity: 0, scale: 0.8 }}
                                            animate={{
                                                opacity: visibleStages.includes(stage.id) ? 1 : 0,
                                                scale: visibleStages.includes(stage.id) ? 1 : 0.8
                                            }}
                                            exit={{ opacity: 0, scale: 0.8 }}
                                            transition={{ duration: 0.5, ease: "easeOut" }}
                                            className="absolute rounded-3xl shadow-2xl backdrop-blur-md"
                                            style={{
                                                left: `${stage.position.x}%`,
                                                top: `${stage.position.y}%`,
                                                transform: 'translate(-50%, -50%)',
                                                width: 'clamp(200px, 25vw, 280px)',
                                                zIndex: 20
                                            }}
                                        >
                                            <GlowingCard className="rounded-3xl h-full">
                                                <div className="p-3 sm:p-5 md:p-6">
                                                    {/* Step Badge with Gradient */}
                                                    <div className="flex items-center justify-between mb-2 sm:mb-3">
                                                        <div className="text-[10px] sm:text-xs font-bold text-white uppercase tracking-wider bg-gradient-to-r from-purple-600 to-violet-600 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg shadow-lg shadow-purple-500/20">
                                                            Step {stage.id}
                                                        </div>
                                                    </div>

                                                    {/* Title */}
                                                    <h3 className="text-sm sm:text-base md:text-lg font-bold text-white mb-1.5 sm:mb-2.5 leading-tight">
                                                        {stage.title}
                                                    </h3>

                                                    {/* Description */}
                                                    <p className="text-[10px] sm:text-xs md:text-sm text-gray-400 leading-relaxed">
                                                        {stage.description}
                                                    </p>
                                                </div>
                                            </GlowingCard>
                                        </motion.div>
                                    ))}
                                </AnimatePresence>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </>
    );
};

export default CustomerLifecycleSection;